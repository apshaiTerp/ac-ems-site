
<!DOCTYPE html>
<html lang="en">
  <head>
    <script type='text/javascript'>//<![CDATA[ 
      var userID     = sessionStorage.getItem("userID");
      var hospitalID = sessionStorage.getItem("hospitalID");

      if (userID == null) {
        window.location = "./login.html";
      }
      if (hospitalID == null) {
        window.location = "./login.html";
      }
   </script>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="img/hospital1.png">

    <title>TerrapinEMS Hospital Administration</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href='http://fonts.googleapis.com/css?family=Fredericka+the+Great|Architects+Daughter|Ubuntu' rel='stylesheet' type='text/css'>
    <link href="css/apshai.css" rel="stylesheet">
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.0/css/bootstrap-toggle.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.5/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css"/>
  </head>

  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand active">TerrapinEMS ER Admin</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
          </ul>
          <form class="navbar-form navbar-right">
            <a href="./login.html" id="logout-button" class="btn btn-success" onclick="logOutFunction()" type="button">Log Out</a>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="bg-login"></div>
    <div class="jumbotron">
      <div class="container">
      </div>
    </div>

    <!-- Login Window Block -->
    <div class="container">
      <h3 align="center" id="name-header">The Hospital Name Goes Here</h3>
      <h5 align="center" id="user-header">Logged in as USERNAME</h5>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
          <div class="panel panel-primary">
            <div class="panel-heading panel-title" id="er-heading">Emergency Room Capacity
            </div>
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-xs-9">
                <strong>Total ER Beds</strong><span class="label label-default label-right" id="erbed-count">20</span>
              </div>
              <div class="col-xs-3"></div>
            </div>
            <div><hr></div>
            <div class="row">
              <div class="col-xs-9">
                <strong>Beds Free</strong><span class="label label-default label-right" id="erbedfree-count">20</span>
              </div>
              <div class="col-xs-3 btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-primary btn-block" id="er-admit-button">Admit 1</button>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-9">
                <strong>Beds Occupied</strong><span class="label label-default label-right" id="erbedoccupied-count">0</span>
              </div>
              <div class="col-xs-3 btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-primary btn-block" id="er-occupied-button">Discharge 1</button>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-9">
                <strong>Beds In Cleanup</strong><span class="label label-default label-right" id="erbedcleanup-count">0</span>
              </div>
              <div class="col-xs-3 btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-primary btn-block" id="er-cleanup-button">Open 1</button>
              </div>
            </div>
            <div><hr></div>
            <div class="row">
              <div class="col-xs-9"><strong>ER Divert Status</strong></div>
              <div class="checkbox-inline col-xs-3">
                <input type="checkbox" id="er-toggle" checked data-toggle="toggle" data-on="Open" data-onstyle="success" data-off="In Diversion" data-offstyle="danger">
              </div>
            </div>
            <div class="row">
              <div class="col-xs-9"><strong>STEMI Divert Status</strong></div>
              <div class="checkbox-inline col-xs-3">
                <input type="checkbox" id="stemi-toggle" checked data-toggle="toggle" data-on="Open" data-onstyle="success" data-off="In Diversion" data-offstyle="danger">
              </div>
            </div>
            <div class="row">
              <div class="col-xs-9"><strong>Stroke Divert Status</strong></div>
              <div class="checkbox-inline col-xs-3">
                <input type="checkbox" id="stroke-toggle" checked data-toggle="toggle" data-on="Open" data-onstyle="success" data-off="In Diversion" data-offstyle="danger">
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
          <div class="panel panel-primary">
            <div class="panel-heading panel-title" id="trauma-heading">Trauma Capacity
            </div>
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-xs-9">
                <strong>Total Trauma Beds</strong><span class="label label-default label-right" id="traumabed-count">20</span>
              </div>
              <div class="col-xs-3"></div>
            </div>
            <div><hr></div>
            <div class="row">
              <div class="col-xs-9">
                <strong>Trauma Beds Free</strong><span class="label label-default label-right" id="traumabedfree-count">20</span>
              </div>
              <div class="col-xs-3 btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-primary btn-block" id="trauma-admit-button">Admit 1</button>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-9">
                <strong>Trauma Beds Occupied</strong><span class="label label-default label-right" id="traumabedoccupied-count">0</span>
              </div>
              <div class="col-xs-3 btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-primary btn-block" id="trauma-occupied-button">Discharge 1</button>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-9">
                <strong>Trauma Beds In Cleanup</strong><span class="label label-default label-right" id="traumabedcleanup-count">0</span>
              </div>
              <div class="col-xs-3 btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-primary btn-block" id="trauma-cleanup-button">Open 1</button>
              </div>
            </div>
            <div><hr></div>
            <div class="row">
              <div class="col-xs-9"><strong>Trauma Divert Status</strong></div>
              <div class="checkbox-inline col-xs-3">
                <input type="checkbox" id="trauma-toggle" checked data-toggle="toggle" data-on="Open" data-onstyle="success" data-off="In Diversion" data-offstyle="danger">
              </div>
            </div>
            <div class="row">
              <div class="col-xs-9"><strong>Burn Unit Divert Status</strong></div>
              <div class="checkbox-inline col-xs-3">
                <input type="checkbox" id="burn-toggle" checked data-toggle="toggle" data-on="Open" data-onstyle="success" data-off="In Diversion" data-offstyle="danger">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Site footer -->
    <div class="container">
      <hr>
      <footer>
        <p>&copy; TerrapinEMS Dispatch 2015 - A Project developed in conjunction with UMKC</p>
      </footer>
    </div> <!-- /container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.0/js/bootstrap-toggle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.5/js/bootstrap-dialog.min.js"></script>
    <script src="js/sockjs-0.3.js"></script>
    <script src="js/stomp.js"></script>

    <script type='text/javascript'>//<![CDATA[ 

      function logOutFunction() {
        sessionStorage.clear();
        localStorage.clear();
        window.location = "./login.html";
      };

      function showModalSuccessDialog(titleText, messageText) {
        BootstrapDialog.show({
          title: titleText,
          message: messageText,
          type: "type-success",
          buttons: [{
              id: 'btn-ok',   
              icon: 'glyphicon glyphicon-check',       
              label: 'OK',
              cssClass: 'btn-primary', 
              autospin: false,
              action: function(dialogRef){    
                  dialogRef.close();
              }
          }]
        });
      };

      function populateHospitalFields() {
        var userID          = sessionStorage.getItem("userID");
        var hospitalID      = sessionStorage.getItem("hospitalID");
        var userDisplayName = sessionStorage.getItem("userDisplayName");

        document.getElementById("user-header").innerHTML = 'Logged in as ' + userDisplayName;

        var gameURL = "http://107.188.249.238:8080/ac-ems-system-rest-0.9/hospital?id=" + hospitalID;
        $.getJSON( gameURL, { format: 'json'} )
            .done(function(data) {  
              var hospitalName       = data['hospitalName'];
              var traumaBeds         = data['traumaBeds'];
              var traumaBedsFree     = data['traumaBedsFree'];
              var traumaBedsOccupied = data['traumaBedsOccupied'];
              var traumaBedsCleanup  = data['traumaBedsCleanup'];
              var erBeds             = data['erBeds'];
              var erBedsFree         = data['erBedsFree'];
              var erBedsOccupied     = data['erBedsOccupied'];
              var erBedsCleanup      = data['erBedsCleanup'];
              var erDivert           = data['erDivert'];
              var traumaDivert       = data['traumaDivert'];
              var burnDivert         = data['burnDivert'];
              var stemiDivert        = data['stemiDivert'];
              var strokeDivert       = data['strokeDivert'];

              document.getElementById("name-header").innerHTML = hospitalName;

              document.getElementById("erbed-count").innerHTML         = erBeds;
              document.getElementById("erbedfree-count").innerHTML     = erBedsFree;
              document.getElementById("erbedoccupied-count").innerHTML = erBedsOccupied;
              document.getElementById("erbedcleanup-count").innerHTML  = erBedsCleanup;

              document.getElementById("traumabed-count").innerHTML         = traumaBeds;
              document.getElementById("traumabedfree-count").innerHTML     = traumaBedsFree;
              document.getElementById("traumabedoccupied-count").innerHTML = traumaBedsOccupied;
              document.getElementById("traumabedcleanup-count").innerHTML  = traumaBedsCleanup;

              if (traumaBeds == 0) {
                //Disable all the buttons

                $('#trauma-admit-button').prop('disabled', true);
                $('#trauma-occupied-button').prop('disabled', true);
                $('#trauma-cleanup-button').prop('disabled', true);
              }

              //Work through all the initial toggle states
              if (erDivert == "open")   { $('#er-toggle').bootstrapToggle('on'); }
              if (erDivert == "divert") { $('#er-toggle').bootstrapToggle('off'); }
              if (erDivert == "na")     { $('#er-toggle').bootstrapToggle('disable'); }

              if (traumaDivert == "open")   { $('#trauma-toggle').bootstrapToggle('on'); }
              if (traumaDivert == "divert") { $('#trauma-toggle').bootstrapToggle('off'); }
              if (traumaDivert == "na")     { $('#trauma-toggle').bootstrapToggle('disable'); }

              if (burnDivert == "open")   { $('#burn-toggle').bootstrapToggle('on'); }
              if (burnDivert == "divert") { $('#burn-toggle').bootstrapToggle('off'); }
              if (burnDivert == "na")     { $('#burn-toggle').bootstrapToggle('disable'); }

              if (stemiDivert == "open")   { $('#stemi-toggle').bootstrapToggle('on'); }
              if (stemiDivert == "divert") { $('#stemi-toggle').bootstrapToggle('off'); }
              if (stemiDivert == "na")     { $('#stemi-toggle').bootstrapToggle('disable'); }

              if (strokeDivert == "open")   { $('#stroke-toggle').bootstrapToggle('on'); }
              if (strokeDivert == "divert") { $('#stroke-toggle').bootstrapToggle('off'); }
              if (strokeDivert == "na")     { $('#stroke-toggle').bootstrapToggle('disable'); }

              //Add Actions for Buttons
              $('#er-admit-button').on('click', function() { sendActionMessage("admiter"); });
              $('#er-occupied-button').on('click', function() { sendActionMessage("dischargeer"); });
              $('#er-cleanup-button').on('click', function() { sendActionMessage("cleanuper"); });
              $('#trauma-admit-button').on('click', function() { sendActionMessage("admittrauma"); });
              $('#trauma-occupied-button').on('click', function() { sendActionMessage("dischargetrauma"); });
              $('#trauma-cleanup-button').on('click', function() { sendActionMessage("cleanuptrauma"); });

              //Add Actions for Toggles
              $('#er-toggle').change(function() {
                if ($(this).prop('checked')) { sendDivertMessage("er", "open"); } else { sendDivertMessage("er", "divert"); }
              });
              $('#trauma-toggle').change(function() {
                if ($(this).prop('checked')) { sendDivertMessage("trauma", "open"); } else { sendDivertMessage("trauma", "divert"); }
              });
              $('#burn-toggle').change(function() {
                if ($(this).prop('checked')) { sendDivertMessage("burn", "open"); } else { sendDivertMessage("burn", "divert"); }
              });
              $('#stemi-toggle').change(function() {
                if ($(this).prop('checked')) { sendDivertMessage("stemi", "open"); } else { sendDivertMessage("stemi", "divert"); }
              });
              $('#stroke-toggle').change(function() {
                if ($(this).prop('checked')) { sendDivertMessage("stroke", "open"); } else { sendDivertMessage("stroke", "divert"); }
              });

        });

      };

      function sendActionMessage(actionType) {
        var hospitalID = sessionStorage.getItem("hospitalID");

        var jsonBody = '{ "hospitalID": "' + hospitalID + '", "actionType" : "' + actionType + '" }';
        $.ajax ({
          type: 'POST',
          url: 'http://107.188.249.238:8080/ac-ems-system-rest-0.9/hospital/beds',
          data: jsonBody,
          contentType: "application/json",
          dataType: 'json',
          success: function(data) {
            var errorType   = data['errorType'];

            if (errorType != null) {
              var errorMessage = data['errorMessage'];
              alert(errorType + ": " + errorMessage);
            } else {
              var traumaBedsFree     = data['traumaBedsFree'];
              var traumaBedsOccupied = data['traumaBedsOccupied'];
              var traumaBedsCleanup  = data['traumaBedsCleanup'];
              var erBedsFree         = data['erBedsFree'];
              var erBedsOccupied     = data['erBedsOccupied'];
              var erBedsCleanup      = data['erBedsCleanup'];

              document.getElementById("erbedfree-count").innerHTML     = erBedsFree;
              document.getElementById("erbedoccupied-count").innerHTML = erBedsOccupied;
              document.getElementById("erbedcleanup-count").innerHTML  = erBedsCleanup;

              document.getElementById("traumabedfree-count").innerHTML     = traumaBedsFree;
              document.getElementById("traumabedoccupied-count").innerHTML = traumaBedsOccupied;
              document.getElementById("traumabedcleanup-count").innerHTML  = traumaBedsCleanup;

              $('#name-header').focus();
            } 
          },
          error: function(jqXHR, textStatus, errorThrown) {
            alert('An Unknown Error Occured During Add Task.  Please Try Again Later.');
          }
        });
      };

      function sendDivertMessage(divertType, divertState) {
        var hospitalID = sessionStorage.getItem("hospitalID");
        var userID     = sessionStorage.getItem("userID");

        var jsonBody = '{ "hospitalID": "' + hospitalID + '", "actionType" : "' + divertType + '", "divertState" : "' + divertState + '", "userID": "' + userID + '" }';
        $.ajax ({
          type: 'POST',
          url: 'http://107.188.249.238:8080/ac-ems-system-rest-0.9/hospital/divert',
          data: jsonBody,
          contentType: "application/json",
          dataType: 'json',
          success: function(data) {
            var errorType   = data['errorType'];

            if (errorType != null) {
              var errorMessage = data['errorMessage'];
              alert(errorType + ": " + errorMessage);
            } 
          },
          error: function(jqXHR, textStatus, errorThrown) {
            alert('An Unknown Error Occured During Add Task.  Please Try Again Later.');
          }
        });
      };

      populateHospitalFields();

      //Add the STOMP stuff
      var webSocket    = new SockJS('http://107.188.249.238:15674/stomp');
      var rabbitClient = Stomp.over(webSocket);
      // SockJS does not support heart-beat: disable heart-beats
      rabbitClient.heartbeat.incoming = 0;
      rabbitClient.heartbeat.outgoing = 0;

      //This is the topic I want to subscribe to.  It should represent my current identify
      var myTopic = '/topic/hosp' + sessionStorage.getItem("hospitalID");

      //Create the helper methods needed to subscribe to the RabbitMQ service
      var onRabbitConnect = function(x) {
        //subscribe to my messages.  In this case, the only action that needs to be taken is a notification
        rabbitClient.subscribe(myTopic, function(message) {
          showModalSuccessDialog("System Notification", message.body);

          //TODO - Once we add in the list of ambulances, we will want to trigger the refresh on the method
          //that handles display.  For now, the call is ready.
        });
      };
      var onRabbitError = function(error) {
        console.log("Something bad happened: " + error.headers);
      };

      /**************************/
      //Create the connection to RabbitMQ
      rabbitClient.connect('ems', 'emsrabbit1', onRabbitConnect, onRabbitError, '/ems');
      /*************************/

      window.onbeforeunload = function() {
        rabbitClient.disconnect(function() {
          console.log("I disconnected");
        });
      };


    </script>
  </body>
</html>
